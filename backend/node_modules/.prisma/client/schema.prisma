generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Role {
  id        Int      @id @default(autoincrement())
  name      String   @unique @db.VarChar(50)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  users     User[]

  @@map("roles")
}

model User {
  id                     Int      @id @default(autoincrement())
  username               String?  @unique @db.VarChar(60)
  email                  String   @unique @db.VarChar(120)
  passwordHash           String   @db.VarChar(255)
  roleId                 Int
  clientId               Int?
  branchId               Int?
  isApproved             Int      @default(0) @db.SmallInt
  firstName              String?  @db.VarChar(80)
  middleName             String?  @db.VarChar(80)
  lastName               String?  @db.VarChar(80)
  telephone              String?  @db.VarChar(50)
  mobileNumber           String?  @db.VarChar(50)
  faxNumber              String?  @db.VarChar(50)
  primaryEmail           String?  @db.VarChar(150)
  alternateEmail1        String?  @db.VarChar(150)
  alternateEmail2        String?  @db.VarChar(150)
  areaHeadManager        String?  @db.VarChar(120)
  areaHeadManagerContact String?  @db.VarChar(50)
  position               String?  @db.VarChar(150)
  department             String?  @db.VarChar(120)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  role               Role                @relation(fields: [roleId], references: [id])
  client             Client?             @relation(fields: [clientId], references: [id])
  branch             SubDomain?          @relation(fields: [branchId], references: [id])
  auditLogs          AuditLog[]
  ocrBatches         OcrBatch[]
  searchLogs         SearchLog[]
  unlockRequests     UnlockRequest[]     @relation("UserUnlockRequests")
  createdNews        News[]
  creditTransactions CreditTransaction[]

  @@index([clientId])
  @@index([branchId])
  @@index([roleId])
  @@index([isApproved])
  @@map("users")
}

model Client {
  id            Int         @id @default(autoincrement())
  clientCode    String      @unique @db.VarChar(50)
  name          String      @db.VarChar(150)
  clientGroup   String?     @db.VarChar(100)
  website       String?     @db.VarChar(255)
  street        String?     @db.VarChar(255)
  barangay      String?     @db.VarChar(150)
  city          String?     @db.VarChar(150)
  province      String?     @db.VarChar(150)
  postalCode    String?     @db.VarChar(20)
  telephone     String?     @db.VarChar(50)
  fax           String?     @db.VarChar(50)
  mobile        String?     @db.VarChar(50)
  email         String?     @db.VarChar(150)
  billingType   BillingType @default(Postpaid)
  creditBalance Decimal     @default(0) @db.Decimal(12, 2)
  creditLimit   Decimal?    @db.Decimal(12, 2)
  isActive      Int         @default(1) @db.SmallInt
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  users              User[]
  subDomains         SubDomain[]
  searchLogs         SearchLog[]
  creditTransactions CreditTransaction[]

  @@index([clientCode])
  @@index([isActive])
  @@index([billingType])
  @@map("clients")
}

enum BillingType {
  Prepaid
  Postpaid
}

model SubDomain {
  id         Int             @id @default(autoincrement())
  clientCode String?         @db.VarChar(50)
  clientId   Int
  name       String          @db.VarChar(150)
  status     SubDomainStatus @default(Active)
  isDeleted  Int             @default(0) @db.SmallInt
  deletedAt  DateTime?
  deletedBy  Int?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  client Client @relation(fields: [clientId], references: [id])
  users  User[]

  @@index([isDeleted])
  @@index([deletedAt])
  @@index([createdAt])
  @@index([clientId])
  @@index([status])
  @@map("sub_domains")
}

enum SubDomainStatus {
  Active
  Inactive
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  action    String   @db.VarChar(100)
  module    String   @db.VarChar(100)
  recordId  Int
  ipAddress String   @db.VarChar(45)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

model NegativeRecord {
  id          Int        @id @default(autoincrement())
  type        RecordType
  firstName   String?    @db.VarChar(120)
  middleName  String?    @db.VarChar(120)
  lastName    String?    @db.VarChar(120)
  companyName String?    @db.VarChar(200)
  details     String?    @db.Text
  source      String?    @db.VarChar(255)
  ocrBatchId  Int?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  ocrBatch       OcrBatch?       @relation(fields: [ocrBatchId], references: [id])
  unlockRequests UnlockRequest[]

  @@index([lastName])
  @@index([companyName])
  @@index([type])
  @@map("negative_records")
}

enum RecordType {
  Individual
  Company
}

model OcrBatch {
  id           Int            @id @default(autoincrement())
  fileName     String         @db.VarChar(255)
  filePath     String         @db.VarChar(500)
  status       OcrBatchStatus @default(pending)
  totalRecords Int            @default(0)
  uploadedBy   Int
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  uploader        User             @relation(fields: [uploadedBy], references: [id])
  negativeRecords NegativeRecord[]

  @@map("ocr_batches")
}

enum OcrBatchStatus {
  pending
  processing
  completed
  failed
}

model SearchLog {
  id         Int        @id @default(autoincrement())
  userId     Int
  clientId   Int
  searchType RecordType
  searchTerm String     @db.VarChar(255)
  isBilled   Int        @default(1) @db.SmallInt
  fee        Decimal    @default(0) @db.Decimal(10, 2)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  user   User   @relation(fields: [userId], references: [id])
  client Client @relation(fields: [clientId], references: [id])

  @@index([clientId])
  @@index([userId])
  @@index([searchTerm])
  @@index([createdAt])
  @@map("search_logs")
}

model UnlockRequest {
  id          Int                 @id @default(autoincrement())
  requestedBy Int
  recordId    Int
  status      UnlockRequestStatus @default(pending)
  reviewedBy  Int?
  reviewedAt  DateTime?
  reason      String?             @db.Text
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  requester      User           @relation("UserUnlockRequests", fields: [requestedBy], references: [id])
  negativeRecord NegativeRecord @relation(fields: [recordId], references: [id])

  @@index([requestedBy])
  @@index([status])
  @@map("unlock_requests")
}

enum UnlockRequestStatus {
  pending
  approved
  denied
}

model News {
  id        Int      @id @default(autoincrement())
  title     String   @db.VarChar(255)
  content   String   @db.Text
  imageUrl  String?  @db.VarChar(500)
  createdBy Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  creator User @relation(fields: [createdBy], references: [id])

  @@map("news")
}

model CreditTransaction {
  id          Int                   @id @default(autoincrement())
  clientId    Int
  amount      Decimal               @db.Decimal(12, 2)
  type        CreditTransactionType
  description String?               @db.VarChar(255)
  performedBy Int
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt

  client    Client @relation(fields: [clientId], references: [id])
  performer User   @relation(fields: [performedBy], references: [id])

  @@index([clientId])
  @@map("credit_transactions")
}

enum CreditTransactionType {
  topup
  deduction
}
